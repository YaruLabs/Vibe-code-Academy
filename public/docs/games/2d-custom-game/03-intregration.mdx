# ğŸ†” Phase 3: Identity Verification (Registration)

We are now entering the advanced logic. We will integrate **`coti-ethers`** to handle authenticated, encrypted transactions using the `CotiEthersSigner`.

This step adds a **Registration Panel** to your dApp. Users can play freely, but must register to mint their rewards.

Replace the current address for your smart contract address.
---

## âš¡ ACTION: IMPLEMENT REGISTRATION FLOW

**Mission:** Go to the **COTI MCP Interface**. Copy the prompt below.

<div style={{
  background: 'linear-gradient(135deg, #14b8a6, #0ea5e9)',
  padding: '3px',
  borderRadius: '16px',
  margin: '30px 0',
  boxShadow: '0 0 50px -10px rgba(14, 165, 233, 0.4)'
}}>
  <div style={{
    background: '#0f172a',
    borderRadius: '13px',
    color: '#e2e8f0',
    overflow: 'hidden',
    fontFamily: 'Menlo, Monaco, Consolas, monospace',
    position: 'relative'
  }}>
    
    {/* Header Bar */}
    <div style={{
      background: 'rgba(255, 255, 255, 0.03)',
      borderBottom: '1px solid #334155',
      padding: '12px 20px',
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center'
    }}>
      <div style={{display: 'flex', alignItems: 'center', gap: '12px'}}>
        <div style={{
            width:'12px', height:'12px', background:'#2dd4bf', borderRadius:'50%', 
            boxShadow:'0 0 12px #2dd4bf'
        }}></div>
        <span style={{color: '#f0f9ff', fontWeight: 'bold', fontSize: '0.85rem', letterSpacing: '0.5px'}}>
          USER_REGISTRY.prompt
        </span>
      </div>

      <button 
        style={{
            background: 'linear-gradient(90deg, #0ea5e9, #2563eb)',
            border: 'none',
            color: 'white',
            padding: '8px 16px',
            borderRadius: '6px',
            fontSize: '0.75rem',
            cursor: 'pointer',
            fontWeight: 'bold',
            display: 'flex', alignItems: 'center', gap: '8px',
            transition: 'transform 0.1s',
            boxShadow: '0 4px 12px rgba(14, 165, 233, 0.3)'
        }}
        onMouseOver={(e) => e.currentTarget.style.transform = 'translateY(-1px)'}
        onMouseOut={(e) => e.currentTarget.style.transform = 'translateY(0)'}
        onClick={() => {
            const promptText = document.getElementById('registry-prompt').innerText;
            navigator.clipboard.writeText(promptText);
            alert("Registry Prompt Copied! Don't forget to set your Address! ğŸ“");
        }}
      >
        <span>âš¡ COPY PROMPT</span>
      </button>
    </div>

    {/* Scrollable Content Area */}
    <div id="registry-prompt" style={{
      padding: '24px',
      maxHeight: '400px', 
      overflowY: 'auto',  
      whiteSpace: 'pre-wrap', 
      fontSize: '0.85rem',
      lineHeight: '1.5',
      color: '#cbd5e1'
    }}>
{`You must extend the existing React + TypeScript + Ethers v6 + COTI SDK application with a new â€œUser Registration Flowâ€ using coti-ethers. Registration is optional for playing, but mandatory for minting. Maintain all existing logic (wallet connection, onboarding, AESKey, game). Do not modify those parts.

You MUST install and import coti-ethers:

npm install @coti-io/coti-ethers

import { CotiEthersSigner } from "@coti-io/coti-ethers";

IMPORTANT:
The signer used for registration and mint MUST be the signer enhanced with AESKey through coti-ethers, not a derived wallet and not a plain ethers signer.

Use this pattern:
const provider = new BrowserProvider(window.ethereum);
const baseSigner = await provider.getSigner();
const signer = new CotiEthersSigner(baseSigner, aesKey);

You MUST always pass the coti-ethers signer when calling contract functions that require authenticated user actions.

â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
CONTRACT ABI (USE EXACTLY AS PROVIDED)
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
[
  { "type": "constructor", "inputs":[{"name":"tokenName","type":"string"},{"name":"tokenSymbol","type":"string"},{"name":"tokenDecimals","type":"uint8"}], "stateMutability":"nonpayable" },
  { "type":"function","name":"requestRegistration","inputs":[],"outputs":[],"stateMutability":"nonpayable" },
  { "type":"function","name":"isRegistered","inputs":[{"name":"account","type":"address"}],"outputs":[{"name":"","type":"bool"}],"stateMutability":"view" },
  { "type":"function","name":"mint","inputs":[{"name":"to","type":"address"},{"name":"amount","type":"uint256"}],"outputs":[],"stateMutability":"nonpayable" },
  { "type":"function","name":"burn","inputs":[{"name":"amount","type":"uint256"}],"outputs":[],"stateMutability":"nonpayable" },
  { "type":"function","name":"transfer","inputs":[{"name":"to","type":"address"},{"name":"amount","type":"uint256"}],"outputs":[{"name":"","type":"bool"}],"stateMutability":"nonpayable" },
  { "type":"function","name":"transferFrom","inputs":[{"name":"from","type":"address"},{"name":"to","type":"address"},{"name":"amount","type":"uint256"}],"outputs":[{"name":"","type":"bool"}],"stateMutability":"nonpayable" },
  { "type":"function","name":"approve","inputs":[{"name":"spender","type":"address"},{"name":"amount","type":"uint256"}],"outputs":[{"name":"","type":"bool"}],"stateMutability":"nonpayable" },
  { "type":"function","name":"allowance","inputs":[{"name":"owner","type":"address"},{"name":"spender","type":"address"}],"outputs":[{"name":"","type":"uint256"}],"stateMutability":"view" },
  { "type":"function","name":"balanceOf","inputs":[{"name":"account","type":"address"}],"outputs":[{"name":"","type":"uint256"}],"stateMutability":"view" },
  { "type":"function","name":"totalSupply","inputs":[],"outputs":[{"name":"","type":"uint256"}],"stateMutability":"view" },
  { "type":"function","name":"name","inputs":[],"outputs":[{"name":"","type":"string"}],"stateMutability":"view" },
  { "type":"function","name":"symbol","inputs":[],"outputs":[{"name":"","type":"string"}],"stateMutability":"view" },
  { "type":"function","name":"decimals","inputs":[],"outputs":[{"name":"","type":"uint8"}],"stateMutability":"view" },
  { "type":"function","name":"owner","inputs":[],"outputs":[{"name":"","type":"address"}],"stateMutability":"view" },
  { "type":"event","name":"Transfer","inputs":[{"name":"from","type":"address","indexed":true},{"name":"to","type":"address","indexed":true},{"name":"value","type":"uint256"}] },
  { "type":"event","name":"Approval","inputs":[{"name":"owner","type":"address","indexed":true},{"name":"spender","type":"address","indexed":true},{"name":"value","type":"uint256"}] },
  { "type":"event","name":"RegistrationRequested","inputs":[{"name":"user","type":"address","indexed":true}] },
  { "type":"event","name":"RegistrationApproved","inputs":[{"name":"user","type":"address","indexed":true}] },
  { "type":"error","name":"Unauthorized","inputs":[] },
  { "type":"error","name":"InvalidAddress","inputs":[] },
  { "type":"error","name":"InsufficientBalance","inputs":[] },
  { "type":"error","name":"InsufficientAllowance","inputs":[] },
  { "type":"error","name":"NotRegistered","inputs":[] },
  { "type":"error","name":"AlreadyRegistered","inputs":[] }
]

â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
NEW FEATURE: USER REGISTRATION FLOW
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

UI/UX Requirements (Expert-Level)
1. Add a new dedicated panel below Onboarding called â€œUser Accessâ€.
2. Inside this panel show:
   - Registration Status indicator (stylish, modern, color-coded)
   - â€œRegisterâ€ button
   - â€œMint / Claim Pointsâ€ button (locked until registration)

3. Registration Status UX:
   Before checking:
      Status: Unknown
      Color: neutral grey
   If not registered:
      Status: Not Registered
      Color: soft red
   If registered:
      Status: Registered
      Color: green
   Must auto-refresh on:
      - Wallet changes
      - After registration tx
      - On page reload (if wallet connected)

4. The â€œRegisterâ€ button:
   - Enabled only when:
        walletConnected === true
        onboardingComplete === true
        aesKey !== null
   - Shows loading animation during tx.
   - After success:
        Update status, show â€œRegisteredâ€.

5. Important UX rule:
   Registration is OPTIONAL for playing the game.
   Registration is REQUIRED for minting.

â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
REGISTRATION LOGIC (MANDATORY IMPLEMENTATION)
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

You MUST use coti-ethers to wrap the signer:

const provider = new BrowserProvider(window.ethereum);
const baseSigner = await provider.getSigner();
const signer = new CotiEthersSigner(baseSigner, aesKey);

You MUST use this signer for:

- requestRegistration()
- isRegistered()
- mint()

NEVER call contract.write functions using the raw ethers signer.
NEVER call using a derived wallet.
NEVER use a private key locally.

â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
FUNCTIONAL REQUIREMENTS
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

1. Checking if user is registered:
const status = await contract.isRegistered(userAddress);

2. Registering user:
const tx = await contract.connect(signer).requestRegistration();
await tx.wait();

3. Unlocking Minting:
The Mint button must be hidden or disabled until:
isRegistered === true

4. Mint Function:
After user is registered:
Execute:

const tx = await contract.connect(signer).mint(userAddress, BigInt(amount));
await tx.wait();

5. UI state to maintain:
isRegistered
isRegistering (loading)
mintStatus
registrationStatusMessage

6. Logging (required):
â€œChecking registrationâ€¦â€
â€œRegistration transaction sent: (hash)â€
â€œRegistration complete.â€
â€œUser is registered.â€
â€œMinting using amount: Xâ€
â€œMint transaction hash: â€¦â€
â€œMint complete.â€

â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
OUTPUT REQUIREMENTS
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

Your response MUST contain ONLY:

1. The React + TypeScript code implementing:
   - The â€œUser Accessâ€ panel
   - Registration button
   - Registration status display
   - Mint button (locked until registered)
   - coti-ethers signer integration

2. MUST NOT modify:
   - Wallet connection logic
   - Onboarding logic
   - AESKey generation logic
   - Game logic
   - Network switching logic

3. UI must be minimal, modern, and clean.
4. English only.
5. No emojis.
6. No extra explanation.
`}
    </div>

    {/* Visual Footer */}
    <div style={{
        background: '#020617',
        borderTop: '1px solid #1e293b',
        padding: '8px 20px',
        display: 'flex', justifyContent: 'flex-end',
        alignItems: 'center', gap: '10px'
    }}>
        <div style={{width:'8px', height:'8px', background:'#2dd4bf', borderRadius:'50%', animation: 'pulse 2s infinite'}}></div>
        <span style={{fontSize: '0.7rem', color: '#94a3b8', fontFamily: 'sans-serif', fontWeight: 'bold'}}>
          SCROLL TO VIEW FULL SPECIFICATION â†•
        </span>
    </div>

  </div>
</div>